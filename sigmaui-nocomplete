local Players = game:GetService('Players')
local ReplicatedStorage = game:GetService('ReplicatedStorage')
local HttpService = game:GetService('HttpService')
local RunService = game:GetService('RunService')
local UserInputService = game:GetService('UserInputService')

local LocalPlayer = Players.LocalPlayer
local Remote = ReplicatedStorage.Packages.Net['RE/LaserGun_Fire']
local Settings = require(ReplicatedStorage.Shared.LaserGunsShared).Settings

Settings.Radius.Value = 255
Settings.MaxBounces.Value = 1e6
Settings.MaxAge.Value = 1e6
Settings.StunDuration.Value = 1e6
Settings.ImpulseForce.Value = 1e6
Settings.Cooldown.Value = 0

local LaggerEnabled = false
local BoomEnabled = false

local ScreenGui = Instance.new('ScreenGui')
ScreenGui.Name = 'LaserGui'
ScreenGui.Parent = LocalPlayer:WaitForChild('PlayerGui')

local MainFrame = Instance.new('Frame')
MainFrame.Size = UDim2.new(0, 180, 0, 120)
MainFrame.Position = UDim2.new(0, 40, 0, 60)
MainFrame.BackgroundColor3 = Color3.new(1, 1, 1)
MainFrame.BackgroundTransparency = 1
MainFrame.Active = true
MainFrame.Parent = ScreenGui

local FrameGradient = Instance.new('UIGradient')
FrameGradient.Color = ColorSequence.new({
    ColorSequenceKeypoint.new(0, Color3.new(1, 0.717, 0.772)),
    ColorSequenceKeypoint.new(1, Color3.new(0.682, 0.886, 1)),
})
FrameGradient.Rotation = 45
FrameGradient.Parent = MainFrame

local FrameCorner = Instance.new('UICorner')
FrameCorner.CornerRadius = UDim.new(0, 12)
FrameCorner.Parent = MainFrame

local LaggerButton = Instance.new('TextButton')
LaggerButton.Size = UDim2.new(1, -20, 0, 35)
LaggerButton.Position = UDim2.new(0, 10, 0, 10)
LaggerButton.Text = 'Lagger: OFF'
LaggerButton.TextColor3 = Color3.new(1, 1, 1)
LaggerButton.Font = Enum.Font.FredokaOne
LaggerButton.TextSize = 16
LaggerButton.BackgroundColor3 = Color3.new(1, 0.713, 0.756)
LaggerButton.AutoButtonColor = false
LaggerButton.Parent = MainFrame

local BoomButton = Instance.new('TextButton')
BoomButton.Size = UDim2.new(1, -20, 0, 35)
BoomButton.Position = UDim2.new(0, 10, 0, 55)
BoomButton.Text = 'BOOM: OFF'
BoomButton.TextColor3 = Color3.new(1, 1, 1)
BoomButton.Font = Enum.Font.FredokaOne
BoomButton.TextSize = 16
BoomButton.BackgroundColor3 = Color3.new(0.713, 0.756, 1)
BoomButton.AutoButtonColor = false
BoomButton.Parent = MainFrame

local ButtonCorner = Instance.new('UICorner')
ButtonCorner.CornerRadius = UDim.new(0, 8)
ButtonCorner.Parent = LaggerButton
local BoomCorner = ButtonCorner:Clone()
BoomCorner.Parent = BoomButton

local LaggerGradient = Instance.new('UIGradient')
LaggerGradient.Color = ColorSequence.new({
    ColorSequenceKeypoint.new(0, Color3.new(1, 0.784, 0.784)),
    ColorSequenceKeypoint.new(1, Color3.new(0.784, 0.862, 1)),
})
LaggerGradient.Rotation = 90
LaggerGradient.Parent = LaggerButton

local BoomGradient = Instance.new('UIGradient')
BoomGradient.Color = ColorSequence.new({
    ColorSequenceKeypoint.new(0, Color3.new(0.784, 0.784, 1)),
    ColorSequenceKeypoint.new(1, Color3.new(0.862, 0.784, 1)),
})
BoomGradient.Rotation = 90
BoomGradient.Parent = BoomButton

local DragData = {
    Dragging = false,
    DragInput = nil,
    DragStart = nil,
    StartPos = nil,
}

local function UpdateDrag(input)
    local Delta = input.Position - DragData.DragStart
    MainFrame.Position = UDim2.new(
        DragData.StartPos.X.Scale,
        DragData.StartPos.X.Offset + Delta.X,
        DragData.StartPos.Y.Scale,
        DragData.StartPos.Y.Offset + Delta.Y
    )
end

local function SetupDrag(Handle)
    Handle.InputBegan:Connect(function(input)
        if input.UserInputType == Enum.UserInputType.MouseButton1 then
            DragData.Dragging = true
            DragData.DragStart = input.Position
            DragData.StartPos = MainFrame.Position
            DragData.DragInput = nil

            input.Changed:Connect(function()
                if input.UserInputState == Enum.UserInputState.End then
                    DragData.Dragging = false
                end
            end)
        end
    end)

    Handle.InputChanged:Connect(function(input)
        if input.UserInputType == Enum.UserInputType.MouseMovement then
            DragData.DragInput = input
        end
    end)
end

SetupDrag(MainFrame)
SetupDrag(LaggerButton)
SetupDrag(BoomButton)

UserInputService.InputChanged:Connect(function(input)
    if DragData.Dragging and input == DragData.DragInput then
        UpdateDrag(input)
    end
end)

local function GetAllPlayers()
    local Targets = {}
    local Char = LocalPlayer.Character
    if not Char or not Char.PrimaryPart then
        return Targets
    end

    for _, Player in Players:GetPlayers() do
        if Player ~= LocalPlayer then
            local TargetChar = Player.Character
            if TargetChar and TargetChar.PrimaryPart then
                table.insert(Targets, Player)
            end
        end
    end
    return Targets
end

local function EquipLaserGun()
    local Char = LocalPlayer.Character
    if not Char then
        return false
    end

    local Backpack = LocalPlayer.Backpack
    local LaserGun = Backpack:FindFirstChild('Laser Gun')

    if LaserGun then
        LaserGun.Parent = Char
        wait(0.2)
        return true
    end
    return false
end

local function EquipAndBoom()
    if EquipLaserGun() then
        wait(0.5)
        local Char = LocalPlayer.Character
        if not Char then
            return
        end

        local Targets = GetAllPlayers()
        for _, Target in Targets do
            local TargetChar = Target.Character
            if TargetChar and TargetChar.PrimaryPart and Char.PrimaryPart then
                local Pos1 = Char.PrimaryPart.Position
                local Pos2 = TargetChar.PrimaryPart.Position
                local Dir = (Pos2 - Pos1).Unit

                for i = 1, 10 do
                    local ID =
                        HttpService:GenerateGUID(false):lower():gsub('-', '')
                    Remote:FireServer(
                        ID,
                        Pos1,
                        Dir,
                        workspace:GetServerTimeNow()
                    )
                end
            end
        end
    end
end

LaggerButton.MouseButton1Click:Connect(function()
    LaggerEnabled = not LaggerEnabled
    LaggerButton.Text = LaggerEnabled and 'Lagger: ON' or 'Lagger: OFF'
    if LaggerEnabled then
        LaggerGradient.Color = ColorSequence.new({
            ColorSequenceKeypoint.new(0, Color3.new(1, 0.627, 0.627)),
            ColorSequenceKeypoint.new(1, Color3.new(1, 0.784, 0.784)),
        })
    else
        LaggerGradient.Color = ColorSequence.new({
            ColorSequenceKeypoint.new(0, Color3.new(1, 0.784, 0.784)),
            ColorSequenceKeypoint.new(1, Color3.new(0.784, 0.862, 1)),
        })
    end
end)

BoomButton.MouseButton1Click:Connect(function()
    BoomEnabled = not BoomEnabled
    BoomButton.Text = BoomEnabled and 'BOOM: ON' or 'BOOM: OFF'
    if BoomEnabled then
        BoomGradient.Color = ColorSequence.new({
            ColorSequenceKeypoint.new(0, Color3.new(0.627, 0.627, 1)),
            ColorSequenceKeypoint.new(1, Color3.new(0.784, 0.627, 1)),
        })
        EquipAndBoom()
    else
        BoomGradient.Color = ColorSequence.new({
            ColorSequenceKeypoint.new(0, Color3.new(0.784, 0.784, 1)),
            ColorSequenceKeypoint.new(1, Color3.new(0.862, 0.784, 1)),
        })
    end
end)

local FireDelay = 0
RunService.RenderStepped:Connect(function(Delta)
    FireDelay = FireDelay + Delta
    local Char = LocalPlayer.Character
    if not Char then
        return
    end

    local Tool = Char:FindFirstChildOfClass('Tool')
    local HasGun = Tool and Tool.Name == 'Laser Gun'

    if not (LaggerEnabled and HasGun) then
        return
    end
    if FireDelay < 0.01 then
        return
    end

    FireDelay = 0
    local Targets = GetAllPlayers()
    if #Targets == 0 then
        return
    end

    local Target = Targets[1]
    local TargetChar = Target.Character
    if not (TargetChar and TargetChar.PrimaryPart and Char.PrimaryPart) then
        return
    end

    local Pos1 = Char.PrimaryPart.Position
    local Pos2 = TargetChar.PrimaryPart.Position
    local Dir = (Pos2 - Pos1).Unit

    for i = 1, 5 do
        local ID = HttpService:GenerateGUID(false):lower():gsub('-', '')
        Remote:FireServer(ID, Pos1, Dir, workspace:GetServerTimeNow())
    end
end)
