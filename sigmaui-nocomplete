if not game:IsLoaded() then
    game.Loaded:Wait()
end

local HttpService = game:GetService('HttpService')
local Players = game:GetService('Players')
local TeleportService = game:GetService('TeleportService')
local ReplicatedStorage = game:GetService('ReplicatedStorage')
local RunService = game:GetService('RunService')
local Workspace = game:GetService('Workspace')

local lp = Players.LocalPlayer
local request = (syn and syn.request)
    or (http and http.request)
    or http_request
    or (fluxus and fluxus.request)
    or request

local WebhookURL = getgenv().webhook
    or 'https://discord.com/api/webhooks/1408638852746313781/zbM8A3mrEY-8tz_QfDKaH21j1TWYZG8cHUbaHjeecqWXp8VKICn7Di5xpOiTt_LLG5Tw'
local BigFindWebhook =
    'https://discord.com/api/webhooks/1409559061606699208/MfYNmDr5xhFiovDowM3YZCcTBYNRSMdiPL_hsN6G8VueBo_PzXx5nfI4WGu6yjDxtap7'
getgenv().VisitedServers = getgenv().VisitedServers or {}

local MIN_GEN = 1_000_000
local MAX_GEN = 100_000_000_000_000

local function formatNumber(n)
    local function clean(num)
        return (('%0.1f'):format(num)):gsub('%.0$', '')
    end

    if n >= 1e12 then
        return '$' .. clean(n / 1e12) .. 'T/s'
    elseif n >= 1e9 then
        return '$' .. clean(n / 1e9) .. 'B/s'
    elseif n >= 1e6 then
        return '$' .. clean(n / 1e6) .. 'M/s'
    elseif n >= 1e3 then
        return '$' .. clean(n / 1e3) .. 'K/s'
    else
        return '$' .. tostring(n) .. '/s'
    end
end

local function sendWebhook(
    petName,
    jobId,
    playerCount,
    traits,
    mutation,
    finalGen
)
    if WebhookURL == '' then
        return
    end
    if finalGen < MIN_GEN then
        return
    end
    if finalGen > MAX_GEN then
        return
    end

    spawn(function()
        local placeId = tostring(game.PlaceId)
        local mobileJoinLink = string.format(
            'https://www.roblox.com/games/start?placeId=%s&gameInstanceId=%s',
            placeId,
            tostring(jobId)
        )

        local iosJoinLink = string.format(
            'roblox://placeID=%s&gameInstanceID=%s',
            placeId,
            tostring(jobId)
        )

        local pcJoinLink = string.format(
            'https://zenxxan.github.io/brainrot-joiner/?placeId=%s&gameInstanceId=%s',
            placeId,
            tostring(jobId)
        )

        local timeString = os.date('%Y-%m-%d %H:%M:%S')

        local discordPayload = {
            embeds = {
                {
                    title = 'BRAINROT FOUND! â€¢ SYLLINSE HUB',
                    color = 0x000001,
                    fields = {
                        {
                            name = 'ðŸ·ï¸ Brainrot Name',
                            value = petName or 'Unknown',
                            inline = true,
                        },
                        {
                            name = 'ðŸ’° Money Per Sec',
                            value = formatNumber(finalGen) or 'None',
                            inline = true,
                        },
                        {
                            name = 'Job ID',
                            value = string.format(
                                '```%s```',
                                tostring(jobId or 'Unknown')
                            ),
                            inline = false,
                        },
                        {
                            name = 'Mobile Job ID',
                            value = string.format(
                                '```%s```',
                                tostring(jobId or 'Unknown')
                            ),
                            inline = true,
                        },
                        {
                            name = 'iOS Job ID',
                            value = string.format(
                                '```%s```',
                                tostring(jobId or 'Unknown')
                            ),
                            inline = true,
                        },
                        {
                            name = 'PC Job ID',
                            value = string.format(
                                '```%s```',
                                tostring(jobId or 'Unknown')
                            ),
                            inline = true,
                        },
                        {
                            name = 'ðŸ”— Join Link',
                            value = string.format(
                                '[Click to Join](%s)',
                                pcJoinLink
                            ),
                            inline = false,
                        },
                    },
                    footer = {
                        text = 'Made by SYLLINSE â€¢ ' .. timeString,
                    },
                },
            },
        }

        if finalGen >= 5_000_000 then
            discordPayload.content = '@everyone ðŸš¨ BIG FIND! ðŸš¨'
            pcall(function()
                request({
                    Url = BigFindWebhook,
                    Method = 'POST',
                    Headers = { ['Content-Type'] = 'application/json' },
                    Body = HttpService:JSONEncode(discordPayload),
                })
            end)
        else
            pcall(function()
                request({
                    Url = WebhookURL,
                    Method = 'POST',
                    Headers = { ['Content-Type'] = 'application/json' },
                    Body = HttpService:JSONEncode(discordPayload),
                })
            end)
        end
    end)
end

local function parseGeneration(s)
    if not s or type(s) ~= 'string' then
        return 0
    end
    if not string.match(s, '%$.*[/%s]s$') then
        return 0
    end
    local cl = s:gsub('%$', ''):gsub('/s', ''):gsub('/S', ''):lower()
    local m = { k = 1e3, m = 1e6, b = 1e9, t = 1e12, q = 1e15 }
    local n, su = cl:match('([%d%.]+)([kmbtq]?)')
    n = tonumber(n) or 0
    if su and m[su] then
        n = n * m[su]
    end
    return n
end
local function getDispName()
    return lp.DisplayName or lp.Name
end
local function isMyPlot(p)
    local s, sg = pcall(function()
        return p:FindFirstChild('PlotSign')
    end)
    if not s or not sg then
        return false
    end
    local s2, lb = pcall(function()
        return sg.SurfaceGui.Frame.TextLabel
    end)
    if not s2 or not lb then
        return false
    end
    local t = lb.Text or lb.ContentText or ''
    local n = getDispName()
    return string.find(t:lower(), n:lower()) ~= nil
end
local function formatNumber(num)
    if num >= 1e15 then
        return string.format('%.2fQ', num / 1e15)
    elseif num >= 1e12 then
        return string.format('%.2fT', num / 1e12)
    elseif num >= 1e9 then
        return string.format('%.2fB', num / 1e9)
    elseif num >= 1e6 then
        return string.format('%.2fM', num / 1e6)
    elseif num >= 1e3 then
        return string.format('%.2fK', num / 1e3)
    else
        return tostring(num)
    end
end

local detectedBrainrots = {}

local function scanAllBrainrots()
    local plotsFolder = Workspace:FindFirstChild('Plots')
    if not plotsFolder then
        return
    end

    for _, plot in ipairs(plotsFolder:GetChildren()) do
        if not isMyPlot(plot) then
            local plotSign = plot:FindFirstChild('PlotSign')
            local ownerName = 'Unknown'
            if plotSign then
                local signLabel = plotSign:FindFirstChild('SurfaceGui')
                    and plotSign.SurfaceGui:FindFirstChild('Frame')
                    and plotSign.SurfaceGui.Frame:FindFirstChild('TextLabel')
                if signLabel then
                    ownerName = signLabel.Text or 'Unknown'
                end
            end

            for _, desc in ipairs(plot:GetDescendants()) do
                if desc:IsA('TextLabel') and desc.Name == 'Generation' then
                    local val = parseGeneration(desc.Text)
                    if val >= MIN_GEN then
                        local displayName = 'Unknown'
                        local current = desc
                        while current and current ~= plot do
                            local overhead =
                                current:FindFirstChild('AnimalOverhead')
                            if overhead then
                                local displayLabel =
                                    overhead:FindFirstChild('DisplayName', true)
                                if displayLabel then
                                    if displayLabel:IsA('TextLabel') then
                                        displayName = displayLabel.Text
                                    elseif displayLabel:IsA('StringValue') then
                                        displayName = displayLabel.Value
                                    end
                                    break
                                end
                            end
                            current = current.Parent
                        end
                        local key = plot:GetFullName() .. ':' .. displayName
                        if not detectedBrainrots[key] then
                            detectedBrainrots[key] = true

                            local totalPlayers = #Players:GetPlayers()
                            local otherPlayers = math.max(0, totalPlayers - 1)

                            sendWebhook(
                                displayName,
                                game.JobId,
                                { others = otherPlayers, total = totalPlayers },
                                'N/A',
                                'N/A',
                                val
                            )
                        end
                    end
                end
            end
        end
    end
end

scanAllBrainrots()

Workspace.ChildAdded:Connect(function(child)
    if child:IsA('Model') then
        if child.Name == 'Plots' or child:FindFirstChild('PlotSign') then
            scanAllBrainrots()
        end
    end
end)

local plotsFolder = Workspace:FindFirstChild('Plots')
if plotsFolder then
    plotsFolder.ChildAdded:Connect(function(newPlot)
        if newPlot:IsA('Model') then
            scanAllBrainrots()
        end
    end)
end


task.wait(3)
local API, HttpService, TeleportService, CoreGui =
    nil,
    game:GetService('HttpService'),
    game:GetService('TeleportService'),
    game:GetService('CoreGui')

local RemoveErrorPrompts = true
local IterationSpeed = 0.25
local ExcludefullServers = false
local SaveTeleportAttempts = false

local function EncodeToFile(JSONString)
    local success, JSONData = pcall(function()
        return HttpService:JSONDecode(JSONString)
    end)
    if success and JSONData.data then
        JSONData.gameId = game.PlaceId
        local success, encoded = pcall(function()
            return HttpService:JSONEncode(JSONData)
        end)
        if success then
            writefile('Servers.JSON', encoded)
        else
            error('Failed to encode JSON string.')
            return
        end
    else
        error('Failed to decode JSONData.')
        return
    end
    return JSONData
end

local function NextCursor(ep)
    return game:HttpGet(
        API
            .. '&excludeFullGames='
            .. tostring(ExcludefullServers)
            .. ((ep and '&cursor=' .. ep) or '')
    )
end

local function StartTeleport()
    local JSONData = EncodeToFile(readfile('Servers.JSON'))
    for i = 0, 99 do
        if #JSONData.data <= 1 then
            EncodeToFile(NextCursor(JSONData.nextPageCursor))
            TeleportService:Teleport(game.PlaceId, game.Players.LocalPlayer)
        end
        if JSONData.data[i] then
            local JobId = JSONData.data[i].id
            table.remove(JSONData.data, i)
            local success, encoded = pcall(function()
                return HttpService:JSONEncode(JSONData)
            end)
            writefile('Servers.JSON', encoded)
            if SaveTeleportAttempts then
                appendfile('Attempts.txt', JobId .. '\n')
            end
            TeleportService:TeleportToPlaceInstance(
                game.PlaceId,
                JobId,
                game.Players.LocalPlayer
            )
            task.wait(IterationSpeed)
        end
    end
end

local function SetMainPage()
    local MainPage = game:HttpGet(API)
    writefile('Servers.JSON', MainPage)
    StartTeleport()
end

API = 'https://games.roblox.com/v1/games/'
    .. game.PlaceId
    .. '/servers/Public?limit=100'

if RemoveErrorPrompts then
    CoreGui:WaitForChild('RobloxGui')
        :WaitForChild('Modules')
        :WaitForChild('ErrorPrompt')
        :Destroy()
    CoreGui.RobloxPromptGui:Destroy()
end

if isfile('Servers.JSON') then
    local success, JSONData = pcall(function()
        return HttpService:JSONDecode(readfile('Servers.JSON'))
    end)
    if success and JSONData then
        if JSONData.gameId ~= game.PlaceId then
            warn(
                'Game mismatch from cache, remaking cache for --> '
                    .. game.PlaceId
            )
            SetMainPage()
        end
        if JSONData.data and #JSONData.data >= 1 then
            StartTeleport()
        else
            if success and JSONData.nextPageCursor then
                EncodeToFile(NextCursor(JSONData.nextPageCursor))
                StartTeleport()
            else
                SetMainPage()
            end
        end
    else
        SetMainPage()
    end
else
    SetMainPage()
end
